---
title: å¦‚ä½•å†™å¥½å‰ç«¯å•å…ƒæµ‹è¯•
date: 2022-12-21 15:15:05
tags:
---

éšç€å‰ç«¯å®ç°çš„ä¸šåŠ¡é€»è¾‘æ„ˆå‘å¤æ‚ï¼Œå‰ç«¯å•å…ƒæµ‹è¯•çš„é‡è¦æ€§ä¹Ÿæ°´æ¶¨èˆ¹é«˜ã€‚

è€Œå¥½çš„å•å…ƒæµ‹è¯•ï¼Œä¸ä»…èƒ½å¤Ÿä¿è¯ä»£ç è´¨é‡ï¼Œè¿˜èƒ½å¤Ÿæé«˜å¼€å‘æ•ˆç‡ã€‚

æœ¬æ–‡å°±æ¥è°ˆè°ˆï¼Œå¦‚ä½•å†™å¥½å‰ç«¯å•å…ƒæµ‹è¯•ã€‚

![unit-testing](https://raw.githubusercontent.com/zxf4399/oss/main/2022/12/22/what-is-unit-testing-min.jpeg)

<!-- more -->

## èƒŒæ™¯

ç®€å•ä»‹ç»ä¸‹èƒŒæ™¯ï¼Œç¬”è€…åœ¨å·¥ä½œä¸­è´Ÿè´£å¼€å‘å‰ç«¯ SDKï¼Œæµ‹è¯•æ¡†æ¶ä½¿ç”¨ [jest](https://jestjs.io/)ã€‚

æˆ‘ä»¬é¡¹ç›®å¯¹ä»£ç æµ‹è¯•è¦†ç›–ç‡æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œéœ€è¦æ»¡è¶³ï¼š

```json
{
  "branches": 80,
  "functions": 80,
  "lines": 80,
  "statements": 80
}
```

æ¯”å¦‚æˆ‘ä»¬éœ€è¦æµ‹è¯•è¿™ä¸ªå‡½æ•°ï¼š

```js
export const getConfig = (name) => {
  return {
    foo: () => {},
    name: name || "Anonymous",
  };
};
```

å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼š

```js
describe("getConfig", () => {
  test("should return name if have the paramter", () => {
    const name = "zxf4399";
    const config = getConfig(name);

    expect(config.name).toBe(name);
  });

  test("should return default name if doesn't have the paramter", () => {
    const config = getConfig();

    expect(config.name).toBe("Anonymous");
  });
});
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash
----------|---------|----------|---------|---------|-------------------
File      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
----------|---------|----------|---------|---------|-------------------
All files |     100 |      100 |      50 |     100 |
 index.js |     100 |      100 |      50 |     100 |
----------|---------|----------|---------|---------|-------------------
Jest: "global" coverage threshold for functions (80%) not met: 50%
Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        0.444 s, estimated 1 s
Ran all test suites.
â€‰ELIFECYCLEâ€‰ Test failed. See above for more details.
```

ç”±äº functions çš„è¦†ç›–ç‡æ²¡æœ‰è¾¾åˆ° 80%ï¼Œæ‰€ä»¥æµ‹è¯•å¤±è´¥äº†ã€‚

## è§£å†³é—®é¢˜-Phase1

ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆï¼š

```js
test("should test foo function", () => {
  const config = getConfig();

  config.foo && config.foo();
});
```

ç»“æœï¼š

```bash
----------|---------|----------|---------|---------|-------------------
File      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
----------|---------|----------|---------|---------|-------------------
All files |     100 |      100 |     100 |     100 |
 index.js |     100 |      100 |     100 |     100 |
----------|---------|----------|---------|---------|-------------------
Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        0.448 s, estimated 1 s
Ran all test suites.
```

æˆ‘ä»¬å‘ç° functions çš„è¦†ç›–ç‡å±…ç„¶è¾¾åˆ°äº† 100%ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰åœ¨ `should test foo function` æµ‹è¯•ç”¨ä¾‹ä¸­è°ƒç”¨ expect å‡½æ•°ï¼Œè¿™åˆç†å—ï¼Ÿ

ç­”æ¡ˆæ˜¯åˆç†çš„ã€‚

è™½ç„¶æˆ‘ä»¬æ²¡æœ‰åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­è°ƒç”¨ expect å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­è°ƒç”¨äº† config.foo å‡½æ•°ï¼Œè€Œ config.foo å‡½æ•°æ˜¯åœ¨ getConfig å‡½æ•°ä¸­å®šä¹‰çš„ï¼Œæ‰€ä»¥ jest ä¼šè®¤ä¸ºæˆ‘ä»¬æµ‹è¯•äº†è¿™ä¸ªå‡½æ•°ã€‚

ä½†å®é™…ä¸Šè¿™ä¸ªæµ‹è¯•è¡Œä¸ºæ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ï¼Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†è¾¾åˆ°æµ‹è¯•è¦†ç›–ç‡çš„è¦æ±‚è€Œè¿™æ ·å†™ã€‚

## è§£å†³é—®é¢˜-Phase2

è§£å†³ Phase1 é—®é¢˜æˆ‘ä»¬éœ€è¦çŸ¥é“ jest çš„æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦‚ä½•è®¡ç®—çš„ã€‚

jest çš„ coverage provider æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š

- [istanbuljs](https://github.com/istanbuljs/nyc)
- [c8](https://github.com/bcoe/c8)

ç”±äºæˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ `coverageProvider` æ˜¯ babel, æ‰€ä»¥æˆ‘ä»¬åªè¦å…³æ³¨ istanbuljs å°±å¯ä»¥äº†ã€‚

é’ˆå¯¹è¿™ç§ noop funciton çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `istanbul ignore next` æ¥å¿½ç•¥è¿™ä¸ªå‡½æ•°çš„æµ‹è¯•è¦†ç›–ç‡ã€‚

```js
export const getConfig = (name) => {
  return {
    foo: /* istanbul ignore next */ () => {},
    name: name || "Anonymous",
  };
};
```

å½“ç„¶æ›´åŠ æ¨èçš„åšæ³•æ˜¯æŠ½è±¡å‡ºä¸€ä¸ª noop functionï¼Œç„¶ååœ¨æµ‹è¯•ç”¨ä¾‹ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

```js
/* istanbul ignore next */
export const noop = () => {};

export const getConfig = (name) => {
  return {
    foo: noop,
    name: name || "Anonymous",
  };
};
```

æœ€ç»ˆçš„ç»“æœä¹Ÿæ˜¯ä»¤äººæ»¡æ„çš„ï¼š

```bash
----------|---------|----------|---------|---------|-------------------
File      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
----------|---------|----------|---------|---------|-------------------
All files |     100 |      100 |     100 |     100 |
 index.js |     100 |      100 |     100 |     100 |
----------|---------|----------|---------|---------|-------------------
Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        0.352 s, estimated 1 s
Ran all test suites.
```

æœ¬å°èŠ‚ Demo [ä¼ é€é—¨](https://github.com/zxf4399/write-better-jest-unit-test/tree/main/src/demo01)

## å¦‚ä½•å†™å¥½å•å…ƒæµ‹è¯•

Phase1 ä¸ Phase2 éƒ½æ˜¯è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼Œä»æŠ€æœ¯ä¸Šè®² Phase2 æ›´åˆç†ä¸€äº›ï¼ˆæœ¬èº« noop function å°±ä¸åº”è¯¥æ˜¯ä¸€ä¸ªè€ƒæ ¸çš„ç‚¹ï¼‰ä½†ä½ ä¹Ÿä¸èƒ½è¯´ Phase1 çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é”™è¯¯çš„ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ€è€ƒå¦‚ä½•å†™å¥½å•å…ƒæµ‹è¯• ğŸ¤”

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¸€ä¸ªæœ€ç®€å•çš„å•å…ƒæµ‹è¯•ï¼š

```js
export const sum = (a, b) => a + b;

// unit test
import { sum } from ".";

describe("sum", () => {
  test("adds 1 + 2 to equal 3", () => {
    expect(sum(1, 2)).toBe(3);
  });
});
```

ä»è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå•å…ƒæµ‹è¯•çš„åŸºæœ¬ç»“æ„ï¼š

1. **å‡†å¤‡è¾“å…¥æ•°æ®**
2. **è°ƒç”¨è¢«æµ‹å‡½æ•°**
3. **æ–­è¨€è¾“å‡ºç»“æœ**

ä»»ä½•å•å…ƒæµ‹è¯•éƒ½å¯ä»¥éµå¾ªè¿™ä¸€ä¸ªæ¡†æ¶ï¼š**given-when-then**ã€‚

éµå¾ªè¿™ä¸ªæ¡†æ¶æ˜¯å¦å°±ä¸€å®šèƒ½å†™å¥½å•å…ƒæµ‹è¯•å‘¢ï¼Ÿå…¶å®ä¸ç„¶ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“ï¼Œå•å…ƒæµ‹è¯•çš„ç‰¹å¾ï¼š

1. **å¤±è´¥åŸå› æ˜ç¡®**
2. **è¡¨ç°åŠ›å¼º**
3. **æ‰§è¡Œé€Ÿåº¦å¿«**

### å¤±è´¥åŸå› æ˜ç¡®

å½“è¾“å…¥ä¸å˜ï¼Œå½“ä¸”ä»…å½“**ä¸šåŠ¡ä»£ç åŠŸèƒ½å˜åŒ–**ï¼Œæµ‹è¯•æ‰ä¼šå¤±è´¥ã€‚

è¿™ä¸ªç‰¹å¾æ˜¯æˆ‘ä»¬é‡æ„ä»£ç çš„ä¿éšœï¼Œå½“æˆ‘ä»¬é‡æ„ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¿ƒçš„ä¿®æ”¹ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ï¼Œåªè¦æµ‹è¯•é€šè¿‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä»£ç å°±æ˜¯æ­£ç¡®çš„ã€‚

### è¡¨ç°åŠ›æå¼º

ä¸¤æ–¹é¢ï¼š

- çœ‹åˆ°æµ‹è¯• case çš„æè¿°ï¼Œå°±çŸ¥é“è¿™ä¸ª case çš„æ„å›¾
- æµ‹è¯•å¤±è´¥æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ°é—®é¢˜

### æ‰§è¡Œé€Ÿåº¦å¿«

å•å…ƒæµ‹è¯•çš„æ‰§è¡Œé€Ÿåº¦æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œèƒ½å¤Ÿå¿«é€Ÿçš„å¾—åˆ°åé¦ˆï¼Œè€Œä¸æ˜¯ç­‰å¾…å¾ˆé•¿æ—¶é—´ã€‚

ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

- Mock å¤–éƒ¨ä¾èµ–ï¼Œæ¯”å¦‚ WebSocket è¿æ¥ï¼Œæ•°æ®åº“è¿æ¥ç­‰
- æµ‹è¯•ä»£ç ä¸åŒ…å«é€»è¾‘ï¼Œä¸ç„¶æµ‹è¯•å¤±è´¥æ—¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“æ˜¯æµ‹è¯•ä»£ç çš„é—®é¢˜è¿˜æ˜¯ä¸šåŠ¡ä»£ç çš„é—®é¢˜ï¼ˆæ»‘ç¨½.jpgï¼‰

### ä¸€ä¸ªå¥½çš„å•å…ƒæµ‹è¯•

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè¾ƒå¥½çš„å•å…ƒæµ‹è¯•çš„ä¾‹å­ï¼š

```js
export class EventEmitter {
  constructor() {
    this.events = {};
  }

  on(event, listener) {
    this.events[event] = this.events[event] || [];
    this.events[event].push(listener);

    return () => this.off(event, listener);
  }

  once(event, listener) {
    const remove = this.on(event, (...args) => {
      remove();
      listener(...args);
    });
  }

  emit(event, ...args) {
    this.events[event]?.forEach((listener) => listener(...args));
  }

  off(event, listener) {
    this.events[event] = this.events[event]?.filter((l) => l !== listener);
  }
}
```

å•å…ƒæµ‹è¯•ï¼š

```js
import { EventEmitter } from ".";

let eventEmitter;

beforeEach(() => {
  eventEmitter = new EventEmitter();
});

describe("EventEmitter", () => {
  describe("on", () => {
    test("should add a listener for an event", () => {
      const listener = jest.fn();

      eventEmitter.on("event", listener);
      eventEmitter.emit("event");
      expect(listener).toHaveBeenCalled();
    });

    test('should remove listener when returned "remove" function is called', () => {
      const listener = jest.fn();
      const remove = eventEmitter.on("event", listener);

      remove();
      eventEmitter.emit("event");
      expect(listener).not.toHaveBeenCalled();
    });
  });

  describe("once", () => {
    test("should add a one-time listener for an event", () => {
      const listener = jest.fn();

      eventEmitter.once("event", listener);
      eventEmitter.emit("event");
      eventEmitter.emit("event");
      expect(listener).toHaveBeenCalledTimes(1);
    });
  });

  describe("emit", () => {
    test("should call all listeners for an event", () => {
      const listener1 = jest.fn();
      const listener2 = jest.fn();

      eventEmitter.on("event", listener1);
      eventEmitter.on("event", listener2);
      eventEmitter.emit("event");
      expect(listener1).toHaveBeenCalled();
      expect(listener2).toHaveBeenCalled();
    });

    test("should pass arguments to listeners", () => {
      const listener = jest.fn();

      eventEmitter.on("event", listener);
      eventEmitter.emit("event", "arg1", "arg2");
      expect(listener).toHaveBeenCalledWith("arg1", "arg2");
    });
  });

  describe("off", () => {
    test("should remove a listener for an event", () => {
      const listener = jest.fn();

      eventEmitter.on("event", listener);
      eventEmitter.off("event", listener);
      eventEmitter.emit("event");
      expect(listener).not.toHaveBeenCalled();
    });
  });
});
```

è¿™ä¸ªæµ‹è¯•ä»£ç çš„ç‰¹ç‚¹ï¼š

- ä»£ç ç®€æ´ï¼Œæ²¡æœ‰å¤šä½™çš„é€»è¾‘
- æµ‹è¯• case çš„æè¿°éå¸¸æ¸…æ™°ï¼Œèƒ½å¤Ÿå¾ˆå¿«çš„çŸ¥é“è¿™ä¸ª case çš„æ„å›¾
- æµ‹è¯• case çš„æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå› ä¸ºæ²¡æœ‰å¤–éƒ¨ä¾èµ–

## æ€»ç»“

ä¸€ä¸ªå¥½çš„å•å…ƒæµ‹è¯•ï¼Œåº”è¯¥ç¬¦åˆ given-when-then çš„åŸåˆ™ï¼Œèƒ½å¤Ÿæ¸…æ™°çš„æè¿°æµ‹è¯•çš„æ„å›¾ï¼Œæ‰§è¡Œé€Ÿåº¦å¿«ï¼Œä¸åŒ…å«é€»è¾‘ã€‚

> ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²åï¼ˆ[åˆ›æ„å…±äº« 3.0 è®¸å¯è¯](https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh)ï¼‰
