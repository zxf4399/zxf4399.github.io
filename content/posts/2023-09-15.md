---
title: "æ¢ç´¢å‰ç«¯æ–°ç‰¹æ€§ï¼šCompute Pressure API"
date: 2023-09-15T20:53:17+08:00
---

## å‰è¨€

å‰å‡ å¤©ï¼Œreview åŒäº‹ä»£ç çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªæ–°çš„ JS API `PressureObserver`ã€‚

é€šè¿‡ä¸€ç•ªæœç´¢ï¼Œå‘ç°è¿™ä¸ª API æ˜¯ [Compute Pressure API](https://www.w3.org/TR/compute-pressure/) çš„ä¸€éƒ¨åˆ†ã€‚

å®ƒçš„ä½œç”¨æ˜¯å¯ä»¥è§‚å¯Ÿ **CPU** çš„å˜åŒ–ã€‚

è¿™æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ

ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœä½ åœ¨ä¸€ä¸ªå…·æœ‰è§†é¢‘ä¼šè®®åŠŸèƒ½çš„ç½‘ç«™ä¸Šè·Ÿåˆ«äººå¼€ä¼šï¼Œä¼šè®®é‡Œçš„äººéƒ½å¼€ç€æ‘„åƒå¤´ã€‚é‚£ä¹ˆä½ çš„è®¾å¤‡çš„ CPU å‹åŠ›å°±ä¼šå¾ˆå¤§ï¼Œå› ä¸ºå®ƒéœ€è¦å¤„ç†å¾ˆå¤šè§†é¢‘æµã€‚å¦‚æœç½‘ç«™ä¸èƒ½æ ¹æ® CPU çš„å‹åŠ›åŠ¨æ€è°ƒæ•´è¿œç«¯è§†é¢‘æµçš„åˆ†è¾¨ç‡ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘ç«™å°±ä¼šå‡ºç°ä½¿ç”¨å¡é¡¿ï¼Œç”šè‡³å‡ºç°ç½‘ç«™å´©æºƒçš„ç°è±¡ã€‚

å¦‚æœæœ‰äº†è¿™ä¸ª APIï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜ä¸å°±è¿åˆƒè€Œè§£äº†å—ï¼Ÿ

ç»†å¿ƒçš„è¯»è€…åº”è¯¥å·²ç»å‘ç°äº†ï¼Œæˆ‘ç»™å‡ºçš„è¿™ä¸ª API çš„é“¾æ¥æ˜¯ W3C çš„ï¼Œè€Œä¸æ˜¯ MDN çš„ã€‚

æ˜¯å› ä¸ºè¿™ä¸ª API è¿˜æ²¡æœ‰è¢« W3C æ ‡å‡†åŒ–ï¼Œç›®å‰è¿˜å¤„äºè‰æ¡ˆé˜¶æ®µï¼Œæ‰€ä»¥ MDN ä¸Šä¹Ÿæ²¡æœ‰ç›¸å…³çš„æ–‡æ¡£ã€‚

é‚£ä¹ˆæœ‰å¿…è¦å»äº†è§£è¿™ä¸ª API å—ï¼Ÿæ¯•ç«Ÿå®ƒè¿˜æ²¡æœ‰è¢«æ ‡å‡†åŒ–ã€‚

æˆ‘è®¤ä¸ºæ˜¯æœ‰å¿…è¦çš„ã€‚å› ä¸ºå®ƒçš„å‡ºç°ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç»™ç”¨æˆ·å¸¦æ¥æ›´å¥½çš„ä½“éªŒã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ª API çš„ demoã€‚

## Compute Pressure API demo

### å‰ç½®æ¡ä»¶

- ä½¿ç”¨ Chrome æµè§ˆå™¨
- Chrome æµè§ˆå™¨ç‰ˆæœ¬ >= 115

å¦‚æœæ»¡è¶³å‰ç½®æ¡ä»¶ï¼Œé‚£ä¹ˆ[demo](https://w3c.github.io/compute-pressure/demo/) API Status çš„å€¼æ˜¯ `enabled`ã€‚

é¦–å…ˆæˆ‘ä»¬ç‚¹å‡» Start æŒ‰é’®ï¼Œæ­¤æ—¶ Pressure çš„çŠ¶æ€æ˜¯ `nominal`ã€‚

> [nominal](https://www.w3.org/TR/compute-pressure/#dom-pressurestate-nominal) è¡¨ç¤º CPU çš„å‹åŠ›æ­£å¸¸

![CleanShot2023-09-16at21.07.05@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/16/CleanShot%202023-09-16%20at%2021.07.05@2x.png)

å¢åŠ  1 ä¸ª worker å¹¶å¼€å¯æ¨¡æ‹Ÿï¼Œæ­¤æ—¶ Pressure çš„çŠ¶æ€æ˜¯ `Fair`ã€‚

> [fair](https://www.w3.org/TR/compute-pressure/#dom-pressurestate-fair) è¡¨ç¤º CPU çš„å‹åŠ›æ­£å¸¸ï¼Œä½†æ˜¯æœ‰ä¸€äº›ä»»åŠ¡æ­£åœ¨è¿è¡Œ

![CleanShot2023-09-16at21.11.43@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/16/CleanShot%202023-09-16%20at%2021.11.43@2x.png)

å¢åŠ åˆ° 6 ä¸ª worker çš„æ—¶å€™ï¼ŒPressure çš„çŠ¶æ€å¼€å§‹å˜ä¸º `Serious`ã€‚

> [serious](https://www.w3.org/TR/compute-pressure/#dom-pressurestate-serious) è¡¨ç¤º CPU çš„å‹åŠ›ä¸¥é‡ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ

![CleanShot2023-09-16at21.18.42@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/16/CleanShot%202023-09-16%20at%2021.18.42@2x.png)

å¢åŠ åˆ° 8 ä¸ª worker çš„æ—¶å€™ï¼ŒPressure çš„çŠ¶æ€å˜ä¸º `Critical`ã€‚

> [critical](https://www.w3.org/TR/compute-pressure/#dom-pressurestate-critical) è¡¨ç¤º CPU çš„å‹åŠ›éå¸¸ä¸¥é‡ï¼Œæ— æ³•æ­£å¸¸å·¥ä½œ

![CleanShot2023-09-16at21.27.41@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/16/CleanShot%202023-09-16%20at%2021.27.41@2x.png)

å…³äº Pressure å„ä¸ªçŠ¶æ€çš„ä¸¥é‡ç¨‹åº¦ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™å¼ è¡¨æ ¼æ¥è¡¨ç¤ºï¼š

| Pressure Status | Severity |
| --------------- | -------- |
| nominal         | âšª       |
| fair            | ğŸŸ¢       |
| serious         | ğŸŸ¡       |
| critical        | ğŸ”´       |

## Use-Cases

ä½“éªŒäº† demo ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“äº† Compute Pressure API å¯ä»¥å®æ—¶åæ˜  CPU çš„å‹åŠ›ã€‚

é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨è¿™ä¸ª API å‘¢ï¼Ÿ

ç›¸ä¿¡å¤§å®¶å¯¹ WebRTC ä¸ä¼šé™Œç”Ÿï¼ŒWebRTC æ˜¯ Web Real-Time Communication çš„ç¼©å†™ã€‚Real-Time çš„æ„æ€æ˜¯å®æ—¶ï¼Œè€Œ Compute Pressure API çš„èƒ½åŠ›ä¹Ÿæ˜¯å®æ—¶åæ˜  CPU çš„å‹åŠ›ã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ª API åœ¨ WebRTC åº”ç”¨çš„åœºæ™¯å¯ä»¥ç”¨æ¥ï¼š

- åŠ¨æ€è°ƒæ•´è§†é¢‘æµçš„è´¨é‡å’Œæ•°é‡
- é€‰æ‹©æ€§çš„å¼€å¯æˆ–å…³é—­è™šæ‹ŸèƒŒæ™¯ï¼Œæ»¤é•œï¼Œé™å™ªç­‰åŠŸèƒ½
- ç­‰ç­‰

## å¦‚ä½•ä½¿ç”¨ Compute Pressure API

é¦–å…ˆæ»¡è¶³[å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)ã€‚

ç„¶åæ³¨å†Œ Compute Pressure çš„ [origin trial](https://developer.chrome.com/origintrials/#/view_trial/1196831600973709313)ã€‚

ä¾æ¬¡å¡«å…¥è¡¨å•ä¸­çš„ä¿¡æ¯ï¼Œç„¶åç‚¹å‡» `Register` æŒ‰é’®ã€‚

![CleanShot2023-09-17at20.42.54@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/17/CleanShot%202023-09-17%20at%2020.42.54@2x.png)

æ³¨æ„è¿™é‡Œçš„ `Web Origin` éœ€è¦å¡«å†™ `https` æˆ– `http`ã€‚

æ³¨å†Œå®Œæˆåï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ª `token`ã€‚

ç„¶ååœ¨ä½ çš„ç½‘ç«™ä¸­æ·»åŠ ä»¥ä¸‹ meta æ ‡ç­¾ï¼š

```html
<meta http-equiv="origin-trial" content="copy from your token" />
```

è¿™æ ·ä½ å°±å¯ä»¥åœ¨ä½ çš„ç½‘ç«™ä¸­ä½¿ç”¨ Compute Pressure API äº†ã€‚ä¸ºäº†é¿å… `token` è¿‡æœŸï¼Œä½ å¯ä»¥æ·»åŠ ä»¥ä¸‹é˜²å¾¡æ€§ä»£ç ï¼š

```js
if ("PressureObserver" in globalThis) {
  // Use PressureObserver interface
}
```

ç»†å¿ƒçš„è¯»è€…åº”è¯¥å‘ç°æˆ‘è¿™é‡Œç”¨äº† `globalThis`ï¼Œå› ä¸º `PressureObserver` å¯ä»¥åœ¨ `worker` ä½¿ç”¨ã€‚

å®é™…ä¸Šï¼Œ`PressureObserver` æ”¯æŒåœ¨ä»¥ä¸‹ contexts ä½¿ç”¨ï¼š

- DedicatedWorker
- SharedWorker
- Window

![CleanShot2023-09-17at20.30.31@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/17/CleanShot%202023-09-17%20at%2020.30.31@2x.png)

æˆ‘ä»¬è¯•ç€åˆ›å»ºä¸€ä¸ª `PressureObserver` å®ä¾‹ï¼š

```js
const observer = new PressureObserver(
  (changes) => {
    /* ... */
  },
  {
    sampleRate: 0.5,
  }
);
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸æŒ‡å®š `sampleRate`ï¼Œé»˜è®¤å€¼æ˜¯ `1`ã€‚

`sampleRate` çš„å•ä½æ˜¯ Hzï¼Œè¡¨ç¤ºæ¯ç§’é‡‡æ ·çš„æ¬¡æ•°ã€‚

ä¸¾ä¸ªä¾‹å­å¦‚æœ `sampleRate` æ˜¯ `0.5`ï¼Œé‚£ä¹ˆå°±æ˜¯æ¯ 2 ç§’é‡‡æ ·ä¸€æ¬¡ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå‘ç‚¹ï¼Œå¦‚æœä½ çš„ `sampleRate` è®¾ç½®ä¸º 2 ä½†ç³»ç»Ÿæœ€å¤šåªèƒ½æä¾› 1 Hz çš„é‡‡æ ·é¢‘ç‡ï¼Œé‚£ä¹ˆæœ€ç»ˆ `PressureObserver` çš„é‡‡æ ·é¢‘ç‡å°±æ˜¯ **1** Hzã€‚

æˆ‘ä»¬ä¹‹å‰åœ¨ demo ä¸­çœ‹åˆ°é‚£ä¸ª emoji è¡¨æƒ…éšç€ worker æ•°é‡çš„å¢åŠ è€Œå‘ç”Ÿå˜åŒ–ï¼Œå‰ææ˜¯ `PressureObserver` çš„ `observer` äº† `cpu`ï¼š

```js
observer.observe("cpu");
```

å®é™…ä¸Šï¼Œ`PressureObserver` è¿˜å¯ä»¥è§‚å¯Ÿ `thermals`ï¼ˆæ•£çƒ­ï¼‰ã€‚

ä½†æ˜¯ç°åœ¨ Chrome åªæ”¯æŒ `cpu`ï¼Œå¯ä»¥ç”¨ `PressureObserver` çš„é™æ€æ–¹æ³• `supportedSources` åˆ¤æ–­ï¼š

```js
console.log(PressureObserver.supportedSources());
```

![CleanShot2023-09-17at21.01.49@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/17/CleanShot%202023-09-17%20at%2021.01.49@2x.png)

å–æ¶ˆ `observer` ä¹Ÿå¾ˆç®€å•ï¼š

```js
observer.unobserve("cpu");
```

åŒæ ·ï¼Œå¦‚æœä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š

```js
observer.disconnect();
```

å–æ¶ˆæ‰€æœ‰çš„ `observer`ï¼Œä½†ç°åœ¨ Chrome è¿˜ä¸æ”¯æŒ `thermals`ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä¾¿åˆ©æ€§è¿˜æ²¡æœ‰ä½“ç°å‡ºæ¥ã€‚

å®é™…ä¸Šæˆ‘æµ‹è¯•ä¸‹æ¥ `PressureObserver` çš„ `callback` å‡½æ•°çš„å‚æ•°è™½ç„¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯æ•°ç»„çš„é•¿åº¦å§‹ç»ˆæ˜¯ 1ã€‚

```js
const observer = new PressureObserver((changes) => {
  // changes.length å§‹ç»ˆä¸º 1
});
```

è™½ç„¶æ•°æ®ç»“æ„æœ‰ç‚¹å¥‡æ€ªï¼Œä½†è¿™å¹¶ä¸å¦¨ç¢æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ª APIã€‚

```js
const observer = new PressureObserver((changes) => {
  switch (changes[0].state) {
    case "nominal": {
    }
    case "fair": {
    }
    case "serious": {
    }
    case "critical": {
    }
    default: {
    }
  }
});
```

æˆ‘ä»¬ä¹‹å‰ä»‹ç»äº† `PressureObserver` çš„ `unobserver` ä¸ `disconnect` æ–¹æ³•ï¼Œé‚£ä¹ˆç»†å¿ƒçš„ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œå¦‚æœè°ƒç”¨è¿™äº›æ–¹æ³•çš„æ—¶å€™ `cpu` çš„å‹åŠ›å‘ç”Ÿäº†å˜åŒ–æ€ä¹ˆåŠï¼Ÿ

`PressureObserver` çš„ `takeRecords` æ–¹æ³•è€ƒè™‘åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼š

![CleanShot2023-09-17at21.21.14@2x](https://raw.githubusercontent.com/zxf4399/oss/main/2023/09/17/CleanShot%202023-09-17%20at%2021.21.14@2x.png)

åœ¨ disconnect å‰é€šè¿‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–åˆ° `cpu` å‹åŠ›çš„å˜åŒ–ã€‚

## æ€»ç»“

`PressureObserver` API å±äº Compute Pressure API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥å®æ—¶åæ˜  CPU çš„å‹åŠ›ï¼Œæœªæ¥è¿˜å¯ä»¥åæ˜ æ•£çƒ­çš„å‹åŠ›ã€‚

å¼€å‘è€…å¯ä»¥é€šè¿‡ç›‘å¬ CPU çš„å˜åŒ–åŠ¨æ€è°ƒæ•´è§†é¢‘æµçš„è´¨é‡å’Œæ•°é‡ï¼Œé€‰æ‹©æ€§çš„å¼€å¯æˆ–å…³é—­è™šæ‹ŸèƒŒæ™¯ç­‰è¡Œä¸ºæå‡ç”¨æˆ·ä½“éªŒã€‚

`PressureObserver` çš„ API ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œè¿˜è€ƒè™‘åˆ°äº†ä¸€äº›è¾¹ç•Œæƒ…å†µï¼Œæ¯”å¦‚åœ¨è°ƒç”¨ `unobserver` æˆ– `disconnect` æ–¹æ³•çš„æ—¶å€™ CPU çš„å‹åŠ›å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ `takeRecords` æ–¹æ³•è·å–åˆ°å‹åŠ›çš„å˜åŒ–ã€‚

è™½ç„¶ç°åœ¨ `PressureObserver` åªèƒ½é€šè¿‡ `origin trial` å¼€å¯ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡å®ƒå¾ˆå¿«å°±ä¼šè¢«æ ‡å‡†åŒ–ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æœŸå¾…å§ï¼
